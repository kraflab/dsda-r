<% provide(:title, 'Stats') %>

<div class="page-header">
  <h1>
    Stats & Charts
  </h1>
</div>

<% cache "stats:#{last_update}" do %>
  <% time_sum = Demo.all.sum(:tics) %>
  <% demo_count = Demo.count %>
  <% player_count = Player.count %>
  <% wad_count = Wad.count %>

  <h4>Number of demos = <%= demo_count %></h4>
  <h4>Number of players = <%= player_count %></h4>
  <h4>Number of wads = <%= wad_count %></h4>
  <h4>Total demo time = <%= Service::Tics::ToString.call(time_sum, with_cs: false) %> </h4>
  <h4>Average demos per player = <%= demo_count / player_count %></h4>
  <h4>Average demos per wad = <%= demo_count/ wad_count %></h4>
  <h4>Average demo time = <%= Service::Tics::ToString.call(time_sum / demo_count, with_cs: false) %></h4>

  <hr>
  <div class="center-text">
    <h3>Record Index Top 20</h3>
    <p>The Record Index is the number of demos beaten by record runs.</p>
    <div class="panel panel-default panel-modest left-text">
      <table class="table table-striped table-modest">
        <thead>
          <tr>
            <th>Player</th>
            <th>Record Index</th>
          </tr>
        </thead>
        <tbody>
          <% @record_index_players.each do |player| %>
            <% cache player do %>
              <tr>
                <td><%= link_to player.name, player_path(player) %></td>
                <td><%= player.record_index %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<div id="wad_count_by_iwad" class="chart-style">
  <%= column_chart iwad_by_wad_count,
  title: 'Wad Count by Iwad',
  nonce: content_security_policy_script_nonce,
  id: 'wad_count_by_iwad', html: '' %>
</div>

<div id="demo_count_by_month" class="chart-style">
  <%= column_chart demos_by_month(Demo),
  title: 'Demo Count by Month',
  nonce: content_security_policy_script_nonce,
  id: 'demo_count_by_month', html: '' %>
</div>
